variables:
  PROJECT_NAME: TestFirebaseAll

stages:
  - build
  - deploy

build-arm64:
  stage: build
  image: rabits/qt:5.15-android
  artifacts:
    name: aab-arm64
    paths:
      - ./dist/build/outputs/bundle/
    expire_in: 1 week
  before_script:
    - echo ${KEYSTORE_FILE} | base64 -d > ./release.keystore
  script:
    - ls
    - mkdir build
    - cd build
    - qmake ../${PROJECT_NAME}.pro -spec android-clang "CONFIG+=qtquickcompiler" ANDROID_ABIS="arm64-v8a"
    - make
    - make INSTALL_ROOT=../dist install
    - cd ..
    - sudo chown -R $(whoami) $ANDROID_HOME
    - androiddeployqt --input ./build/android-${PROJECT_NAME}-deployment-settings.json --output ./dist 
      --aab --deployment bundled --gradle --jarsigner --sign ./release.keystore ${KEY_ALIAS} --storepass ${KEY_PASSWORD}

deploy:
  stage: deploy
  image: zl0i/firebase-cli:latest
  before_script:
    - export FIREBASE_TOKEN=${FIREBASE_TOKEN}
  script:
    - ls -R ./dist/build/outputs/bundle/
    - firebase appdistribution:distribute ./dist/build/outputs/bundle/release/dist-release.aab
      --app ${AppID}
      --release-notes "Bug fixes and improvements"
